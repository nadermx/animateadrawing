{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Character - {{ project.name }} | Animate a Drawing{% endblock %}
{% block meta_description %}Upload a character drawing to your animation project. Supports PNG, JPG, GIF, and WebP.{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'animator:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'animator:project_detail' project_id=project.id %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'animator:character_list' project_id=project.id %}">Characters</a></li>
            <li class="breadcrumb-item active">Upload</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Upload Character Drawing</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="upload-form">
                        {% csrf_token %}

                        <!-- Drop Zone -->
                        <div class="upload-zone text-center py-5 border border-2 border-dashed rounded mb-4"
                             id="drop-zone" style="border-color: #dee2e6; cursor: pointer;">
                            <input type="file" name="image" id="image-input" accept="image/*" class="d-none" required>
                            <div id="upload-placeholder">
                                <i class="bi bi-cloud-arrow-up text-muted" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">Drop your drawing here</h5>
                                <p class="text-muted mb-0">or click to browse</p>
                                <p class="small text-muted mt-2">Supports: PNG, JPG, GIF, WebP (up to 10MB)</p>
                            </div>
                            <div id="upload-preview" class="d-none">
                                <img id="preview-image" src="" alt="Preview" class="img-fluid rounded" style="max-height: 300px;">
                                <p class="mt-2 mb-0">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="change-image">
                                        Change Image
                                    </button>
                                </p>
                            </div>
                        </div>

                        <!-- Character Name -->
                        <div class="mb-3">
                            <label for="name" class="form-label">Character Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                   placeholder="e.g., Main Hero, Sidekick, Monster" value="Character">
                        </div>

                        <!-- Character Type -->
                        <div class="mb-4">
                            <label for="character_type" class="form-label">Character Type</label>
                            <select class="form-select" id="character_type" name="character_type">
                                {% for value, label in character_types %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">This helps our AI detect the pose more accurately.</div>
                        </div>

                        <!-- Submit -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                                <i class="bi bi-upload me-2"></i> Upload & Detect Pose
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tips -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Tips for Best Results</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Use a <strong>transparent or solid color background</strong> for best pose detection</li>
                        <li>Make sure the character has <strong>visible arms and legs</strong> (not hidden behind objects)</li>
                        <li>Use a <strong>front-facing or 3/4 view</strong> pose</li>
                        <li>T-pose or arms-away-from-body works best for automatic detection</li>
                        <li>Recommended image size: <strong>500-2000 pixels</strong> on the longest side</li>
                    </ul>
                </div>
            </div>

            {% if templates %}
            <!-- Character Templates -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Or Use a Template</h5>
                    <a href="{% url 'animator:template_library' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for template in templates|slice:":4" %}
                        <div class="col-3">
                            <a href="#" class="text-decoration-none" data-template-id="{{ template.id }}">
                                <img src="{{ template.preview_image.url }}" alt="{{ template.name }}"
                                     class="img-fluid rounded border">
                                <p class="small text-center mt-1 mb-0">{{ template.name }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.upload-zone:hover {
    border-color: #0d6efd !important;
    background-color: #f8f9fa;
}
.upload-zone.drag-over {
    border-color: #0d6efd !important;
    background-color: #e7f1ff;
}
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const imageInput = document.getElementById('image-input');
    const placeholder = document.getElementById('upload-placeholder');
    const preview = document.getElementById('upload-preview');
    const previewImage = document.getElementById('preview-image');
    const submitBtn = document.getElementById('submit-btn');
    const changeBtn = document.getElementById('change-image');

    dropZone.addEventListener('click', () => imageInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
            imageInput.files = e.dataTransfer.files;
            handleFile(e.dataTransfer.files[0]);
        }
    });

    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    changeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        imageInput.value = '';
        placeholder.classList.remove('d-none');
        preview.classList.add('d-none');
        submitBtn.disabled = true;
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please upload an image file');
            return;
        }
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be under 10MB');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            placeholder.classList.add('d-none');
            preview.classList.remove('d-none');
            submitBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}
