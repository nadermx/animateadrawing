{% extends 'base.html' %}
{% load static %}

{% block title %}Storyboard - {{ project.name }} | Animate a Drawing{% endblock %}
{% block meta_description %}Plan your animation with a visual storyboard. Sketch scenes before you animate.{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'animator:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'animator:project_detail' project_id=project.id %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">Storyboard</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Storyboard</h1>
            <p class="text-muted mb-0">Plan your animation visually before diving into details</p>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary me-2" id="add-panel">
                <i class="bi bi-plus-lg me-1"></i> Add Panel
            </button>
            <a href="{% url 'animator:timeline_editor' project_id=project.id %}" class="btn btn-success">
                <i class="bi bi-film me-1"></i> Open Timeline
            </a>
        </div>
    </div>

    <!-- Storyboard Panels -->
    <div class="row g-4" id="storyboard-panels">
        {% for panel in panels %}
        <div class="col-md-4 col-lg-3" data-panel-id="{{ panel.id }}">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <span class="badge bg-secondary">Panel {{ panel.order|add:1 }}</span>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" data-move="up">
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-move="down">
                            <i class="bi bi-arrow-down"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="panel-sketch bg-light rounded d-flex align-items-center justify-content-center"
                         style="height: 150px; cursor: pointer;">
                        {% if panel.sketch %}
                        <img src="{{ panel.sketch.url }}" alt="Panel {{ panel.order|add:1 }}" class="img-fluid">
                        {% else %}
                        <div class="text-muted text-center">
                            <i class="bi bi-brush" style="font-size: 2rem;"></i>
                            <p class="small mb-0">Click to sketch</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer p-2">
                    <textarea class="form-control form-control-sm" rows="2"
                              placeholder="Panel notes...">{{ panel.notes }}</textarea>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5" id="empty-state">
            <div class="mb-4">
                <i class="bi bi-grid-3x3-gap text-muted" style="font-size: 4rem;"></i>
            </div>
            <h3>No storyboard panels yet</h3>
            <p class="text-muted mb-4">Start planning your animation by adding panels.</p>
            <button type="button" class="btn btn-primary btn-lg" id="add-first-panel">
                <i class="bi bi-plus-lg me-2"></i> Add First Panel
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Help Section -->
    <div class="row mt-5">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-light">
                <div class="card-body">
                    <h5><i class="bi bi-lightbulb me-2"></i>Storyboarding Tips</h5>
                    <ul class="mb-0">
                        <li><strong>Keep it simple:</strong> Rough sketches are fine - focus on composition and action</li>
                        <li><strong>Note the action:</strong> Write what happens in each panel</li>
                        <li><strong>Think about timing:</strong> Indicate how long each shot should last</li>
                        <li><strong>Camera notes:</strong> Add notes about zooms, pans, or camera movement</li>
                        <li><strong>Dialogue/Audio:</strong> Include any dialogue or sound cues</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sketch Modal -->
<div class="modal fade" id="sketchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sketch Panel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <canvas id="sketch-canvas" class="w-100 border rounded" height="400" style="cursor: crosshair;"></canvas>
                <div class="mt-2 d-flex justify-content-between">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" data-tool="brush">
                            <i class="bi bi-brush"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-tool="eraser">
                            <i class="bi bi-eraser"></i>
                        </button>
                    </div>
                    <input type="range" class="form-range" style="width: 100px;" min="1" max="20" value="5" id="brush-size">
                    <button type="button" class="btn btn-outline-danger" id="clear-canvas">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-sketch">Save Sketch</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add panel functionality
    document.getElementById('add-panel')?.addEventListener('click', addPanel);
    document.getElementById('add-first-panel')?.addEventListener('click', addPanel);

    function addPanel() {
        // In full implementation, this would add a new panel via AJAX
        alert('Panel creation would be handled here via AJAX');
    }

    // Sketch canvas (simplified - would be more complex in production)
    const sketchCanvas = document.getElementById('sketch-canvas');
    if (sketchCanvas) {
        const ctx = sketchCanvas.getContext('2d');
        let isDrawing = false;

        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, sketchCanvas.width, sketchCanvas.height);

        sketchCanvas.addEventListener('mousedown', () => isDrawing = true);
        sketchCanvas.addEventListener('mouseup', () => isDrawing = false);
        sketchCanvas.addEventListener('mousemove', function(e) {
            if (!isDrawing) return;
            const rect = sketchCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.beginPath();
            ctx.arc(x, y, document.getElementById('brush-size').value / 2, 0, Math.PI * 2);
            ctx.fillStyle = '#000';
            ctx.fill();
        });

        document.getElementById('clear-canvas')?.addEventListener('click', function() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, sketchCanvas.width, sketchCanvas.height);
        });
    }
});
</script>
{% endblock %}
